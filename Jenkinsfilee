pipeline {
  agent any

  environment {
    APP_NAME       = "myapp"
    K8S_SERVICE    = "myapp-service"

    BLUE_LABEL     = "blue"
    GREEN_LABEL    = "green"

    AWS_ACCOUNT_ID = "123456789012"
    AWS_REGION     = "ap-south-1"

    IMAGE_TAG      = "${env.BUILD_NUMBER}"
    ECR_REPO       = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${APP_NAME}"
    IMAGE          = "${ECR_REPO}:${IMAGE_TAG}"

    AWS_CREDS_ID   = "aws-creds"
    KUBECONFIG_ID  = "kubeconfig-file-cred"
    SONARQUBE_ENV  = "sonarqube"
  }
  
    stage('Checkout Code') {
      steps {
        git branch: "main", url: "github-repo-url"
      }
    }

    stage('Build Docker Image') {
      steps {
        sh """
          echo "Building docker image"
          docker build -t ${APP_NAME}:${IMAGE_TAG} .
        """
      }
    }
	
	 stage('SonarQube Scan') {
      steps {
        withSonarQubeEnv("${SONARQUBE_ENV}") {
          sh """
            mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${APP_NAME}
          """
        }
      }
    }
	
	 stage('Push Image to ECR') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding',
                          credentialsId: AWS_CREDS_ID]]) {

          sh """
            aws ecr get-login-password --region ${AWS_REGION} \
              | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

            docker tag ${APP_NAME}:${IMAGE_TAG} ${IMAGE}
            docker push ${IMAGE}
          """
        }
      }
    }
	
	
	stage('Switch Traffic to GREEN') {
  steps {
    sh """
      kubectl patch svc myapp-service \
        -p '{"spec":{"selector":{"version":"green"}}}'
    """
  }
}

stage('Verify GREEN Traffic') {
  steps {
    sh """
      echo "Checking if GREEN pods are receiving traffic..."

      kubectl get pods -l version=green -o wide

      echo "Checking service endpoints..."
      kubectl get endpoints myapp-service -o wide
    """
  }
}

post {
  failure {
    sh """
      kubectl patch svc myapp-service \
        -p '{"spec":{"selector":{"version":"blue"}}}'
    """
  }
}
